
CREATE TABLE dwd_lazada_trd_fulfillment_create_ri(
    venture VARCHAR,
    stat_date VARCHAR,
    stat_hour VARCHAR,
    trade_order_line_id BIGINT,
    trade_order_id BIGINT,
    seller_id BIGINT,
    buyer_id BIGINT,
    quantity BIGINT,
    asc_sku_id VARCHAR,
    asc_item_id VARCHAR,
    data_time VARCHAR,
    client_type VARCHAR,
    actual_gmv DOUBLE,
    actual_gmv_usd DOUBLE,
    PRIMARY KEY(venture,trade_order_line_id)
) WITH(
    accessId='1577696621774RNVED',
    accessKey='2dca517f-ff21-4c4b-80f1-f0a82a75bae4',
    type='tt',
    lengthCheck='PAD',
    lineDelimiter='\n',
    nullValues='\\N|',
    fetchFirstRow='true',
    topic='dwd_lazada_trd_fulfillment_create_ri',
    fieldDelimiter='\u0001',
    encoding='utf-8'
);


CREATE TABLE dwi_pub_hbd_slr_dtr_001(
    rowkey VARCHAR,
    seller_id VARCHAR,
    venture VARCHAR,
    stat_date VARCHAR,
    pay_ord_amt_dtr_001 DOUBLE,
    pay_mord_cnt_dtr_001 BIGINT,
    pay_ord_byr_cnt_dtr_001 BIGINT,
    pay_ord_itm_qty_dtr_001 BIGINT,
    PRIMARY KEY(rowkey)
) WITH(
    zkQuorum='hbasemaster74000.sg94.tbsite.net,hbasemaster74001.sg94.tbsite.net,hbasemaster74002.sg94.tbsite.net,hbase74000.sg94.tbsite.net,hbase74001.sg94.tbsite.net',
    zkNodeParent='/group-sg94-lzd-mix',
    type='alihbase',
    columnFamily='info',
    tableName='dwi_pub_hbd_slr_dtr_001',
    stringWriteMod='true'
);


CREATE VIEW v_dwd_lzd_trd_fulfillment_create_ri
AS
SELECT
    trade_order_line_id
    ,FIRST_VALUE(venture) AS venture
    ,FIRST_VALUE(stat_date) AS stat_date
    ,FIRST_VALUE(stat_hour) AS stat_hour
    ,FIRST_VALUE(trade_order_id) AS trade_order_id
    ,CAST(FIRST_VALUE(seller_id) AS VARCHAR) AS seller_id
    ,FIRST_VALUE(buyer_id) AS buyer_id
    ,FIRST_VALUE(quantity) AS quantity
    ,FIRST_VALUE(actual_gmv) AS actual_gmv
FROM
    dwd_lazada_trd_fulfillment_create_ri
WHERE COALESCE(trade_order_line_id, '') <> ''
AND   stat_date >= '${stat_date_value}'
GROUP BY
    trade_order_line_id
;


INSERT INTO dwi_pub_hbd_slr_dtr_001
SELECT CONCAT_WS(
            '\u0004'
            ,CONCAT( SUBSTRING(MD5(CONCAT(seller_id, '${day_appid}')), 1, 4) ,':md5' )
            ,CONCAT(seller_id, ':seller')
            ,CONCAT('${day_appid}', ':app')
            ,CONCAT(venture, ':venture')
            ,CONCAT('ddd:', stat_date)
        ) AS rowkey
        ,seller_id
        ,venture
        ,stat_date
        ,pay_ord_amt_dtr_001
        ,pay_mord_cnt_dtr_001
        ,pay_ord_byr_cnt_dtr_001
        ,pay_ord_itm_qty_dtr_001
FROM
    (
        SELECT
            seller_id
            ,venture
            ,stat_date
            ,SUM(actual_gmv) AS pay_ord_amt_dtr_001
            ,COUNT(DISTINCT trade_order_id) AS  pay_mord_cnt_dtr_001
            ,COUNT(DISTINCT buyer_id) AS pay_ord_byr_cnt_dtr_001
            ,SUM(quantity) AS pay_ord_itm_qty_dtr_001
            ,MAX(CONCAT(stat_date, stat_hour)) AS hourkey
        FROM
            v_dwd_lzd_trd_fulfillment_create_ri
        GROUP BY
            seller_id
            ,venture
            ,stat_date
);
